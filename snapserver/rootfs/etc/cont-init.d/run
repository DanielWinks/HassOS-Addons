#!/usr/bin/with-contenv bashio
declare name
declare pipe
declare stream
declare bit
declare device_type
declare add_opts

pre="source = librespot:///usr/bin/librespot"
def="volume=100&normalize=true&disable_audio_cache=true&killall=false"

# Create snapcast dir
if ! bashio::fs.directory_exists "/data/snapcast"; then
  mkdir -p /data/snapcast ||
    bashio::exit.nok "Could not create Snapcast config folder!"
fi

# Create TTS FIFO in /share/
if bashio::config.true "create_tts_fifo_in_share"; then
  pipe=/share/snapfifo
  if [[ ! -p $pipe ]]; then
    mkfifo $pipe ||
      bashio::exit.nok "Could not create named pipe!"
    chmod 666 $pipe ||
      bashio::exit.nok "Could not set permissions on pipe!"
  fi
  echo "source = pipe:///${pipe}?name=TTS" >>/etc/snapserver.conf
  bashio::log.info "Created pipe at ${pipe}"
fi

# Create Librespot sources in Snapcast
if bashio::config.true "start_librespot"; then
  for librespot in $(bashio::config 'librespot_instances|keys'); do

    name=$(bashio::config "librespot_instances[${librespot}].name")
    if bashio::config.has_value "librespot_instances[${librespot}].bitrate"; then
      bit=$(bashio::config "librespot_instances[${librespot}].bitrate")
    else
      bit="320"
    fi
    if bashio::config.has_value "librespot_instances[${librespot}].device_type"; then
      device_type=$(bashio::config "librespot_instances[${librespot}].device_type")
    else
      device_type="speaker"
    fi
    if bashio::config.has_value "librespot_instances[${librespot}].additional_opts"; then
      add_opts=$(bashio::config "librespot_instances[${librespot}].additional_opts")
    else
      add_opts=""
    fi

    add_opts="${add_opts} --device-type ${device_type}"
    add_opts=$(echo $add_opts | sed -f /etc/url_escape.sed)
    stream="${pre}?name=${name}&devicename=${name}&bitrate=${bit}&params=${add_opts}&${def}"

    echo ${stream} >>/etc/snapserver.conf
    bashio::log.info "Snapcast Conf: ${stream}"

    if bashio::config.true "create_tts_fifo_in_share"; then
      stream="source = meta:///TTS/${name}?name=${name} + TTS"
      echo ${stream} >>/etc/snapserver.conf
      bashio::log.info "Snapcast Conf: ${stream}"
    fi
  done
fi
